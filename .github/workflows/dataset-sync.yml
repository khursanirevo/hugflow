name: Hugflow Dataset Sync

on:
  pull_request:
    paths:
      - 'requests/add/**'
      - 'requests/remove/**'
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}

jobs:
  sync:
    runs-on: self-hosted
    timeout-minutes: 999999
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install -e .
          pip install datasets  # Additional dependency for dataset loading

      - name: Comment download started
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `### üöÄ Starting Download\n\nDownloading dataset... This may take hours or days depending on size.\n\nI'll post progress updates every 10,000 files.`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Download dataset
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          python -m hugflow sync --ci-mode --progress-interval=10000

      - name: Comment download result
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let results = { status: 'failed' };
            try {
              results = JSON.parse(fs.readFileSync('results.json', 'utf8'));
            } catch (err) {}

            const emoji = results.status === 'success' ? '‚úÖ' : '‚ùå';
            const title = results.status === 'success' ? 'Download Complete' : 'Download Failed';

            let comment = `### ${emoji} ${title}\n\n`;
            comment += `**Dataset:** ${results.dataset_name || 'Unknown'}\n`;
            comment += `**Files downloaded:** ${results.file_count || 0}\n`;

            if (results.status === 'failed') {
              comment += `\n**Error:** ${results.error || 'Unknown error'}\n`;
            } else {
              comment += `\n**Location:** \`${results.storage_path}\`\n`;
              comment += `\nAuto-merging PR...\n`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Auto-merge on success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            // Get PR details to extract branch ref
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const branchRef = pr.head.ref;

            // Merge the PR
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              commit_title: 'Auto-merge: Dataset download successful',
              commit_message: 'Automatically merged after successful dataset download.',
              merge_method: 'merge'
            });

            // Delete the branch after merge
            try {
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${branchRef}`
              });
              console.log(`‚úÖ Deleted branch: ${branchRef}`);
            } catch (err) {
              console.log(`‚ö†Ô∏è Could not delete branch ${branchRef}:`, err.message);
            }
